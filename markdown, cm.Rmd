---
title: "Final Project"
author: "Cypress Marrs, Briana Cervantes"
date: "12/3/2021"
output: html_document
---

# GOALS

-   is it late over 2 mins y/n LOGISTiC

## model put ins

-   lag time

-   time of day (at least two hours out)

-   line

-   station pickup (diff stations will be treated as a cat variable)

-   weather data

## model outputs 

-   is the train going to be late over 2 mins. at pickup station? Y/N

## lines we'll be working with

## Graphics - deliverable

-   Y/N outcomes for any variables

## Codewise to do, next steps: 

-   ~~choose two lines~~

-   merge the weather

    -   use this as a numeric variable at first

-   ~~merge stop location~~

    -   each stop as cat variable

-   at least get the code logistic regression

-   last step visuals

-   last last step revise, feat engineer

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r initial, include=FALSE, warning=FALSE, message=FALSE}
# Libraries -----------------
library(tidyr)
library(dplyr)
library(lubridate)
library(sf)
library(tidycensus)
library(tidyverse)
library(tigris)
library(riem)
library(gridExtra)
library(knitr)
library(kableExtra)
library(caret)
library(knitr) 
library(pscl)
library(plotROC)
library(gtsummary) #for table cause broom always f's everything up
library(pROC)
library(tibble)
## FOR MAPS ~~
library(RColorBrewer)
library(ggmap)  
library(maps)
library(mapdata)


options(tigris_class = "sf")
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")


palette6 <- c("#260a03", "#a81010", "#f8cd12", "#f2fdff", "#93afdc", "#0c0e1d" )

palette5 <- c("#260a03", "#a81010", "#f8cd12", "#f2fdff", "#93afdc", "#0c0e1d" )

palette4 <- c("#a81010", "#f8cd12", "#93afdc", "#0c0e1d" )

palette3 <- c("#a81010", "#f8cd12", "#93afdc")

palette2 <- c("#260a03", "#a81010")

plotTheme2 <-function(base_size = 12, title_size = 18) {
  theme(
    panel.background =element_blank(), 
    text = element_text( color = "#0c0e1d", family="Helvetica"),
    plot.title = element_text(size = title_size, colour = "#0c0e1d", family="Helvetica", face="bold"), 
    plot.subtitle = element_text(face="italic", family="Helvetica", colour = "#0c0e1d"),
    plot.caption = element_text(hjust=0, colour = "#0c0e1d", family="Helvetica"),

    axis.ticks.y = element_line(color = "grey80", size = 0.1),
    plot.background =element_blank(),
    
    panel.grid.major.x   = element_line("grey80", size =0.1 ),
    panel.grid.major.y   =element_line("grey80", size = 0.05),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "#93afdc", fill=NA, size=4),
    #panel.spacing = unit(c(2,2,2,2), "cm"),
    strip.background = element_rect(fill = NA, color = "#f2fdff"),
    strip.text = element_text(size=12,color ="#0c0e1d", family="Helvetica"),
    axis.title = element_text(size=12, color ="#0c0e1d", family="Helvetica",  face="italic"),
    axis.text = element_text(size=10, color ="#0c0e1d", family="Helvetica",),
    
    legend.background = element_blank(),
    legend.title = element_text(colour = "#0c0e1d", face = "italic", family="Helvetica"),
    legend.text = element_text(colour = "#0c0e1d", face = "italic", family="Helvetica"),
    strip.text.x = element_text(size = 14, family="Helvetica", colour = "#0c0e1d")
  )
}


plotTheme3 <-function(base_size = 12, title_size = 18) {
  theme(
    panel.background=element_rect(fill = "#93afdc", color = "#f2fdff"), 
    text = element_text( color = "#0c0e1d", family="Helvetica"),
    plot.title = element_text(size = title_size, colour = "#0c0e1d", family="Helvetica", face="bold"), 
    plot.subtitle = element_text(face="italic", family="Helvetica", colour = "#0c0e1d"),
    plot.caption = element_text(hjust=0, colour = "#0c0e1d", family="Helvetica"),

    axis.ticks.y = element_line(color = "grey80", size = 0.1),
    plot.background =element_blank(),
    
    panel.grid.major.x   = element_line("grey80", size =0.1 ),
    panel.grid.major.y   =element_line("grey80", size = 0.05),
    panel.grid.minor = element_blank(),
    panel.border =element_blank(),
    #panel.spacing = unit(c(2,2,2,2), "cm"),
    strip.background = element_rect(fill = "#f2fdff", color = "#f2fdff"),
    strip.text = element_text(size=12,color ="#0c0e1d", family="Helvetica"),
    axis.title = element_text(size=12, color ="#0c0e1d", family="Helvetica",  face="italic"),
    axis.text = element_text(size=10, color ="#0c0e1d", family="Helvetica",),
    
    legend.background = element_blank(),
    legend.title = element_text(colour = "#0c0e1d", face = "italic", family="Helvetica"),
    legend.text = element_text(colour = "#0c0e1d", face = "italic", family="Helvetica"),
    strip.text.x = element_text(size = 14, family="Helvetica", colour = "#f2fdff")
  )
}




```

```{r datatrains}
# Data -----------
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
jan2019 <- read.csv("https://raw.githubusercontent.com/bri-ne/MUSA508-Final/faf21b758b644d975bb7aa67c5687a38374c05b7/data/2019_01.csv?token=AVSVPET277ZFADOVJ6VXJ2TBWPIGW")
feb2019 <- read.csv("https://raw.githubusercontent.com/bri-ne/MUSA508-Final/faf21b758b644d975bb7aa67c5687a38374c05b7/data/2019_02.csv?token=AVSVPEW4NWROQR43GFRYKJTBWPIL4")
mar2019 <- read.csv("https://raw.githubusercontent.com/bri-ne/MUSA508-Final/faf21b758b644d975bb7aa67c5687a38374c05b7/data/2019_03.csv?token=AVSVPERDSFIVXOGEUPPJRPTBWPIOI")
weather.Data <- 
  riem_measures(station = "EWR", date_start = "2019-01-01", date_end = "2019-05-01")
```

```{r wrangledate}
njtransitdf <- rbind(jan2019, feb2019, mar2019)


njtransitdf <- njtransitdf %>% 
  mutate(scheduled_time_dt = as_datetime(scheduled_time),
         actual_time_dt = as_datetime(actual_time),
         delay_dt = seconds(as.integer(delay_minutes*60)), 
         intervalhour = floor_date(scheduled_time_dt, unit= "hour"),
         week = week(intervalhour)) %>%
  na.omit(delay_dt)

```

```{r stations}
stoplocations <- read.csv("https://raw.githubusercontent.com/bri-ne/MUSA508-Final/main/Rail_Stations_of_NJ_Transit.csv?token=AVSVPEVU7X6RXZP3RNOK2CLBW7VZO")

stoplocations <- stoplocations %>%rename(X = "ï..X")%>%st_as_sf(coords = c("X", "Y"), crs =3424, agr = "constant") 

#stoplocations <- stoplocations %>%st_as_sf(coords = c("ï..X", "Y"), crs =3424, agr = "constant") 
```

```{r template}

## Filters down to Week 1- 10
## Train on 8 test on 2 weeks 
train.template <- 
  filter(njtransitdf, week %in% c(1: 10))%>%filter(line == "Bergen Co. Line " | line == "Gladstone Branch")



#### TRYING TO GET A FEAT WHERE IF PREV STOP WAS LATE, NEXT STOP WILL BE LATE ------

## JUST BERGEN, *Not Grouped By Anything* 

berg <- train.template%>%filter(line == "Bergen Co. Line ")

  # grouping by all the things we want to investigate later, so we don't lose detail: 
  ### specifically adding train_id, so that we can nest in tibble
bergInterval <- berg%>%group_by(train_id, stop_sequence, from, to, intervalhour)%>%summarize(late = mean(delay_dt, na.rm=T))%>%arrange(intervalhour)%>% 
                                                                                mutate(lagHour = dplyr::lag(late,1),
                                                                                         lag2Hours = dplyr::lag(late,2),
                                                                                         lag3Hours = dplyr::lag(late,3),
                                                                                         lag4Hours = dplyr::lag(late,4),
                                                                                         lag12Hours = dplyr::lag(late,12),
                                                                                         lag1day = dplyr::lag(late,24),
                                                                                        lag1week = dplyr::lag(late, 168)) ## This is a Study Panel               

## JUST GLADSTONE, *Not Grouped By Anything* 

glad <- train.template%>%filter(line == "Gladstone Branch")

  # grouping by all the things we want to investigate later, so we don't lose detail: 
gladInterval <- glad%>%group_by(train_id, stop_sequence, from, to, intervalhour)%>%summarize(late = mean(delay_dt, na.rm=T))%>%arrange(intervalhour)%>%
                                                                                mutate(lagHour = dplyr::lag(late,1),
                                                                                         lag2Hours = dplyr::lag(late,2),
                                                                                         lag3Hours = dplyr::lag(late,3),
                                                                                         lag4Hours = dplyr::lag(late,4),
                                                                                         lag12Hours = dplyr::lag(late,12),
                                                                                         lag1day = dplyr::lag(late,24),
                                                                                        lag1week = dplyr::lag(late, 168)) ## This is a Study Panel

### MAKING NA 0

gladInterval[c("lagHour", "lag2Hours", "lag3Hours", "lag4Hours", "lag12Hours","lag1day", "lag1week")][is.na(gladInterval[c("lagHour", "lag2Hours", "lag3Hours", "lag4Hours", "lag12Hours","lag1day", "lag1week")])] <- 0 


bergInterval[c("lagHour", "lag2Hours", "lag3Hours", "lag4Hours", "lag12Hours","lag1day", "lag1week")][is.na(bergInterval[c("lagHour", "lag2Hours", "lag3Hours", "lag4Hours", "lag12Hours","lag1day", "lag1week")])] <- 0 



gladInterval <- gladInterval%>%mutate(lateM = late/60,
                              hour= hour(intervalhour),
                              daynumeric= wday(intervalhour),
                              week = week(intervalhour),
                              weekday = weekdays(intervalhour),
            late_catagorical = ifelse(late < minutes(1), "ontime", ifelse(late < minutes(4), "few_minutes", "late")))

bergInterval <- bergInterval%>%mutate(lateM = late/60,
                              hour= hour(intervalhour),
                              daynumeric= wday(intervalhour),
                              week = week(intervalhour),
                              weekday = weekdays(intervalhour),
            late_catagorical = ifelse(late < minutes(1), "ontime", ifelse(late < minutes(4), "few_minutes", "late")))


```

```{r stationsGEOMS}

#### MAKING A COPY b/c THIS SHIT KEEPS NOT WORKIGN

bergInterval2 <- bergInterval
gladInterval2 <- gladInterval


### THIS can be moved to a more appropriate spot later, but for now: 

  ## First, merge with stop data:
  

station_id <- unique(stoplocations$STATION_ID)

  ### Getting the names the same 
      
      ## GLAD ~~~~

gladInterval2$from<-replace(gladInterval2$from, gladInterval2$from == "Hoboken", "Hoboken Terminal")
gladInterval2$to<-replace(gladInterval2$to, gladInterval2$to == "Hoboken", "Hoboken Terminal")

gladInterval2$from<-replace(gladInterval2$from, gladInterval2$from == "Secaucus Upper Lvl", "Secaucus Junction Upper Level")
gladInterval2$to<-replace(gladInterval2$to, gladInterval2$to == "Secaucus Upper Lvl", "Secaucus Junction Upper Level")

gladstops <- unique(gladInterval2$from)
length(gladstops)

gladID <- stoplocations%>%
  filter(STATION_ID %in% gladstops)
#lenght(gladID)

gladGEOM <- gladInterval%>%merge(gladID, by.x ="from", by.y="STATION_ID") 

      ## BERG ~~~~






stoplocations <- stoplocations%>%mutate(STATION_ID = ifelse(COUNTY == "Orange, NY" & STATION_ID == "Middletown", "Middletown NY", STATION_ID))

bergInterval2$from<-replace(bergInterval2$from, bergInterval2$from == "Broadway Fair Lawn", "Broadway")
bergInterval2$from<-replace(bergInterval2$from, bergInterval2$from == "Glen Rock Boro Hall", "Glen Rock-Boro Hall")
bergInterval2$from<-replace(bergInterval2$from, bergInterval2$from == "Hoboken", "Hoboken Terminal")
bergInterval2$from<-replace(bergInterval2$from, bergInterval2$from == "Radburn Fair Lawn", "Radburn")
bergInterval2$from<-replace(bergInterval2$from, bergInterval2$from == "Ramsey Main St", "Ramsey")
bergInterval2$from<-replace(bergInterval2$from, bergInterval2$from == "Ramsey Route 17", "Rte 17 Ramsey")
bergInterval2$from<-replace(bergInterval2$from, bergInterval2$from == "Secaucus Lower Lvl", "Secaucus Junction Lower Level")


bergInterval2$to<-replace(bergInterval2$to, bergInterval2$to == "Broadway Fair Lawn", "Broadway")
bergInterval2$to<-replace(bergInterval2$to, bergInterval2$to == "Glen Rock Boro Hall", "Glen Rock-Boro Hall")
bergInterval2$to<-replace(bergInterval2$to, bergInterval2$to == "Hoboken", "Hoboken Terminal")
bergInterval2$to<-replace(bergInterval2$to, bergInterval2$to == "Radburn Fair Lawn", "Radburn")
bergInterval2$to<-replace(bergInterval2$to, bergInterval2$to == "Ramsey Main St", "Ramsey")
bergInterval2$to<-replace(bergInterval2$to, bergInterval2$to == "Ramsey Route 17", "Rte 17 Ramsey")
bergInterval2$to<-replace(bergInterval2$to, bergInterval2$to == "Secaucus Lower Lvl", "Secaucus Junction Lower Level")

bergstops <- unique(bergInterval2$from)

length(bergstops)
bergID <- stoplocations%>%
  filter(STATION_ID %in% bergstops)
length(bergID)

bergGEOM <- bergInterval%>%merge(bergID, by.x ="from", by.y="STATION_ID")
bergGEOM <-bergGEOM%>%st_as_sf( crs =3424, agr = "constant")
gladGEOM <-gladGEOM%>%st_as_sf( crs =3424, agr = "constant")






## this is nothing of importance:

test<-bergGEOM%>%dplyr::filter(hour == 13 & week ==2 & daynumeric == 5)


testG<-gladGEOM%>%dplyr::filter(hour == 13 & week ==2 & daynumeric == 5)










```


#  Getting Stop Lag

No weather yet.

## Steps
-   Just doing this for one train first?
-   get only regression variables
-   make stop lag
-   divide train and test 
-   run regression


### Remaking Model 3:
```{r stoplag}

## Remaking Model 3 with STOP LAG: Calling it 3b: GLADSTONE LINE PROTOTYPE

### Adding our Y variable -----
gladModel<- gladInterval%>%mutate(y2_numeric = ifelse(late < minutes(2), 0, 1),
                                  y2 = ifelse(late < minutes(2), "no", "yes"),
                                  y5_numeric = ifelse(late < minutes(5), 0, 1),
                                 y5 = ifelse(late < minutes(5), "no", "yes"),
                                 tuesWed.binary = ifelse(weekday == "Tuesday"|weekday == "Wednesday", 1, 0),
                                  toPenn.binary =  ifelse(to == "New York Penn Station", 1, 0))


### Subsetting the DF -----




gladModel<-gladModel%>%dplyr::select(
                                        train_id,
                                        stop_sequence,
                                        from, 
                                        to,
                                        late,
                                        week,
                                        weekday, 
                                        hour,
                                        lagHour, 
                                        lag2Hours, 
                                        lag3Hours, 
                                        y2, 
                                        intervalhour,
                                        y2_numeric,
                                        tuesWed.binary,
                                        toPenn.binary)

## THIS WORKS NO TIBBLE NEEDED::::
gladModel.good <-gladModel%>%group_by(train_id)%>%arrange(stop_sequence)%>%mutate(onestoplag = dplyr::lag(late),
                                                                          twostoplag = dplyr::lag(late))%>%ungroup()


gladModel.good[c("onestoplag","twostoplag")][is.na(gladModel.good[c("onestoplag","twostoplag")])] <- 0 


### Splitting train and test ----

gladModel.good <- mutate(gladModel.good, week_numeric = as.numeric(week))



set.seed(2121)
gladTrain <- filter(gladModel.good, week < 9)
gladTest <- filter(gladModel.good, week >= 9)



#### Model 3b ----


#### Running the Model

Model3b<- glm(y2_numeric ~ .,
                        data=gladTrain %>% 
                          dplyr::select(y2_numeric,
                                        from, to, onestoplag, twostoplag, weekday, hour),  
                        family="binomial" (link="logit"))



summary3b.table <- tbl_regression(Model3b, exponentiate = TRUE)

#### Setting up Predictions

testProbs3b <- data.frame(Outcome = as.factor(gladTest$y2_numeric),
                         Probs = predict(Model3b, gladTest, type="response"))



#### FIGURE OUT WHAT THRESH with plot and iterate fn

## TEST PROBS PLOT **MODEL 3b -- to figure out what threh**

 threeb<- ggplot(testProbs3b, aes(x = Probs, fill = as.factor(Outcome))) + 
  geom_density() +
  facet_grid(Outcome ~ .) +
  scale_fill_manual(values = palette2) +
  labs(x = "Late Over 2 Mins", y = "Density of probabilities",
       title = "Third Model. B: Distribution of Predicted Probabilities by Actual Outcome",
       caption= "has stop lags") +
  theme(strip.text.x = element_text(size = 18),
        legend.position = "none")#+plotTheme2()





testProbs3b.thresholds <- 
  iterateThresholds(data=testProbs3b, observedClass = Outcome, 
                    predictedProbs = Probs)

testProbs3b.thresholds<-testProbs3b.thresholds%>%arrange(Rate_TP,Rate_TN) ## 0.46 identified

roc.3b<- ggplot(testProbs3b, aes(d = as.numeric(Outcome), m = Probs)) +
  geom_roc(n.cuts = 50, labels = FALSE, colour = "#a81010") +
  style_roc(theme = theme_grey) +
  geom_abline(slope = 1, intercept = 0, size = 1.5, color = 'grey') +
  labs(title = "ROC Curve - Model 3b")+plotTheme2()


testProbs3b <- 
  testProbs3b %>%
  mutate(predOutcome  = as.factor(ifelse(testProbs3b$Probs > 0.46 , 1, 0)))

Model3b.vars <- colnames(gladModel.good%>%dplyr::select(from, to, onestoplag, twostoplag, weekday, hour))

#### Cross Validation 

ctrl <- trainControl(method = "cv", number = 100, classProbs=TRUE, summaryFunction=twoClassSummary)

cvFit3b <- caret::train(y2 ~ .,
                       data=gladModel.good %>%dplyr::select(all_of(Model3b.vars), y2), ### in the book, they cv on all the data
                       method="glm", family="binomial",
                       metric="ROC", trControl = ctrl)

cvFit3b.plot<- dplyr::select(cvFit3b$resample, -Resample) %>%
  gather(metric, value) %>%
  left_join(gather(cvFit3b$results[2:4], metric, mean)) %>%
  ggplot(aes(value)) + 
  geom_histogram(bins=35, fill = "#93afdc") +
  facet_wrap(~metric) +
  geom_vline(aes(xintercept = mean), colour = "#a81010", linetype = 3, size = 1.5) +
  scale_x_continuous(limits = c(0, 1)) +
  labs(x="Goodness of Fit", y="Count", title="MODEL 3 Goodness of Fit Metrics",
       subtitle = "Across-fold mean reprented as dotted lines",
       caption= "Fig.10") +
  plotTheme2()

pROC::auc(testProbs3b$Outcome, testProbs3b$Probs)

## MODEL 3c ------

#### Running the Model



Model3c<- glm(y2_numeric ~ .,
                        data=gladTrain %>% 
                          dplyr::select(y2_numeric,
                                        stop_sequence, onestoplag, hour, toPenn.binary, tuesWed.binary),  
                        family="binomial" (link="logit"))

summary3c.table <- tbl_regression(Model3c, exponentiate = TRUE) ### looks like tuesday or wednesday are sig but other days for this line are not



#### Setting up Predictions


testProbs3c <- data.frame(Outcome = as.factor(gladTest$y2_numeric),
                         Probs = predict(Model3c, gladTest, type="response"))


#### FIGURE OUT WHAT THRESH with plot and iterate fn

## TEST PROBS PLOT **MODEL 3b -- to figure out what threh**


 threec<- ggplot(testProbs3c, aes(x = Probs, fill = as.factor(Outcome))) + 
  geom_density() +
  facet_grid(Outcome ~ .) +
  scale_fill_manual(values = palette2) +
  labs(x = "Late Over 2 Mins", y = "Density of probabilities",
       title = "Third Model. B: Distribution of Predicted Probabilities by Actual Outcome",
       caption= "has stop lags") +
  theme(strip.text.x = element_text(size = 18),
        legend.position = "none")#+plotTheme2()

 
 testProbs3c.thresholds <- 
  iterateThresholds(data=testProbs3c, observedClass = Outcome, 
                    predictedProbs = Probs)

testProbs3c.thresholds<-testProbs3c.thresholds%>%arrange(Rate_TP,Rate_TN) ## 0.46 identified

roc.3c<- ggplot(testProbs3c, aes(d = as.numeric(Outcome), m = Probs)) +
  geom_roc(n.cuts = 50, labels = FALSE, colour = "#a81010") +
  style_roc(theme = theme_grey) +
  geom_abline(slope = 1, intercept = 0, size = 1.5, color = 'grey') +
  labs(title = "ROC Curve - Model 3b")#+plotTheme2()

testProbs3c <- 
  testProbs3c %>%
  mutate(predOutcome  = as.factor(ifelse(testProbs3c$Probs > 0.46 , 1, 0)))


plot_grid(threeb, threec, nrow = 2)

pROC::auc(testProbs3c$Outcome, testProbs3c$Probs)






```


## Getting Weather Data

### STEPS: 
-   get weather data
-   run regression again

#### Weather Data
```{r dataweather}
# Data -----------
weather.Panel <-  
  weather.Data %>%
    mutate_if(is.character, list(~replace(as.character(.), is.na(.), "0"))) %>% 
    replace(is.na(.), 0) %>%
    mutate(intervalhour = ymd_h(substr(valid, 1, 13))) %>%
    mutate(dotw = wday(intervalhour, label=TRUE)) %>%
    group_by(intervalhour) %>%
    summarize(Temperature = max(tmpf),
              Percipitation = sum(p01i),
              Wind_Speed = max(sknt)) %>%
    mutate(Temperature = ifelse(Temperature == 0, 42, Temperature)) 

#Bring in other data sources and join in legible ways that will make data useable 


```

```{r weatherMERGE}
glad.weather.panel <- merge(x= gladModel.good, y= weather.Panel, by= 'intervalhour', all.x= T)

glad.weather.panel <- 
glad.weather.panel%>% 
      group_by(intervalhour) %>% 
    arrange(intervalhour) %>% 

    mutate(lag1Hourwind = dplyr::lag(Wind_Speed,1),
           lag2Hourswind = dplyr::lag(Wind_Speed,2),  ##taking note from the pres today about windspeed 
           lag3Hourswind = dplyr::lag(Wind_Speed,3),
           lag4Hourswind = dplyr::lag(Wind_Speed,4),
           lag12Hourswind = dplyr::lag(Wind_Speed,12),
           lag1daywind = dplyr::lag(Wind_Speed,24)) %>% 
   ungroup()



### Making all new NAs ZERO ~~~~

glad.weather.panel[c("lag1Hourwind",  "lag2Hourswind", "lag3Hourswind", "lag4Hourswind", "lag12Hourswind", "lag1daywind")][is.na(glad.weather.panel[c( "lag1Hourwind", "lag2Hourswind", "lag3Hourswind", "lag4Hourswind", "lag12Hourswind", "lag1daywind")])] <- 0 



```


#### Running Model 3.c again

```{r MODEL3cWeawther}

## Gotta split again: 

### Splitting train and test ----




set.seed(2121)
gladTrainW <- filter(glad.weather.panel, week < 9)
gladTestW <- filter(glad.weather.panel, week >= 9)




## MODEL 3c ------

#### Running the Model



Model3cW<- glm(y2_numeric ~ .,
                        data=glad.weather.panel %>% 
                          dplyr::select(y2_numeric,
                                        stop_sequence, 
                                        onestoplag, 
                                        hour, 
                                        toPenn.binary, 
                                        tuesWed.binary, 
                                        Wind_Speed,
                                        lag4Hourswind,   ## these are the only winds that were sig
                                        lag1daywind,),  
                        family="binomial" (link="logit"))



summary3cW.table <- tbl_regression(Model3cW, exponentiate = TRUE)
#### Setting up Predictions


testProbs3cW <- data.frame(Outcome = as.factor(gladTestW$y2_numeric),
                         Probs = predict(Model3cW, gladTestW, type="response"))


#### FIGURE OUT WHAT THRESH with plot and iterate fn

## TEST PROBS PLOT **MODEL 3b -- to figure out what threh**


 threecW<- ggplot(testProbs3cW, aes(x = Probs, fill = as.factor(Outcome))) + 
  geom_density() +
  facet_grid(Outcome ~ .) +
  scale_fill_manual(values = palette2) +
  labs(x = "Late Over 2 Mins", y = "Density of probabilities",
       title = "Third Model. cW: Distribution of Predicted Probabilities by Actual Outcome",
       caption= "WEATHER has stop lags") +
  theme(strip.text.x = element_text(size = 18),
        legend.position = "none")#+plotTheme2()

 
 testProbs3cW.thresholds <- 
  iterateThresholds(data=testProbs3cW, observedClass = Outcome, 
                    predictedProbs = Probs)

testProbs3cW.thresholds<-testProbs3cW.thresholds%>%arrange(Rate_TP,Rate_TN) ## 0.51 identified

roc.3cW<- ggplot(testProbs3cW, aes(d = as.numeric(Outcome), m = Probs)) +
  geom_roc(n.cuts = 50, labels = FALSE, colour = "#a81010") +
  style_roc(theme = theme_grey) +
  geom_abline(slope = 1, intercept = 0, size = 1.5, color = 'grey') +
  labs(title = "ROC Curve - Model 3cW")#+plotTheme2()

testProbs3cW <- 
  testProbs3cW %>%
  mutate(predOutcome  = as.factor(ifelse(testProbs3cW$Probs > 0.51 , 1, 0)))


plot_grid(threeb, threec, threecW, nrow = 3)

pROC::auc(testProbs3cW$Outcome, testProbs3cW$Probs) #0.7296






```








# Previous Code Cleaning & Break Up --- OLD SETUP CODE

## Creating panels

```{r trainpanel}


train.panel <- 
  train.template %>%
    right_join(study.panel, on=intervalhour) %>% 
      group_by(intervalhour, from, line)



### Breaking this up to curb unecessary processing on a bunch of NAS

train.panel <- train.panel%>%drop_na()

train.panel <- train.panel%>%summarize(late = mean(delay_dt, na.rm=T)) %>%
  mutate(daynumeric= wday(intervalhour),
        late_catagorical = ifelse(late < minutes(1), "ontime", ifelse(late < minutes(4), "few_minutes", "late")))

#leave this for potential use as a cat. 


## NEW Train Panel

### Making all new NAs ZERO ~~~~
NEWstudypanel[c("lagHour", "lag2Hours", "lag3Hours", "lag4Hours", "lag12Hours","lag1day")][is.na(NEWstudypanel[c("lagHour", "lag2Hours", "lag3Hours", "lag4Hours", "lag12Hours","lag1day")])] <- 0 



NEWtrainpanel <- NEWstudypanel%>%mutate(daynumeric= wday(intervalhour),
                                        week = week(intervalhour),
                                        weekday = weekdays(intervalhour),
                                        late_catagorical = ifelse(late < minutes(1), "ontime", ifelse(late < minutes(4), "few_minutes", "late")),)


```


```{r studypanel}

## 
study.panel <- 
  expand.grid(intervalhour = unique(train.template$intervalhour), 
              from = unique(train.template$from),
              stopseq=unique(train.template$stop_sequence))
              #line= unique(train.template$line))

## NEW Study Panel: Adding column for line and Rbind this mfs 
## if we want them combined 

NEWstudypanel<- rbind((gladInterval%>%mutate(line="Gladstone Branch")), (bergInterval%>%mutate(line="Bergen Co. Line")))

```




```{r lags}
train.weather.panel <- merge(x= train.panel, y= weather.Panel, by= 'intervalhour', all.x= T)

train.weather.panel <- 
  train.weather.panel %>% 
    arrange(line, intervalhour) %>% 
    group_by(line) %>% 
    mutate(lagHour = dplyr::lag(late,1),
           lag2Hours = dplyr::lag(late,2),
           lag3Hours = dplyr::lag(late,3),
           lag4Hours = dplyr::lag(late,4),
           lag12Hours = dplyr::lag(late,12),
           lag1day = dplyr::lag(late,24),
           lag2Hoursrain = dplyr::lag(Percipitation,2),
           lag3Hoursrain = dplyr::lag(Percipitation,3),
           lag4Hoursrain = dplyr::lag(Percipitation,4),
           lag12Hoursrain = dplyr::lag(Percipitation,12),
           lag1dayrain = dplyr::lag(Percipitation,24),
           
           lag2Hourstemp = dplyr::lag(Temperature,2),
           lag3Hourstemp = dplyr::lag(Temperature,3),
           lag4Hourstemp = dplyr::lag(Temperature,4),
           lag12Hourstemp = dplyr::lag(Temperature,12),
           lag1daytemp = dplyr::lag(Temperature,24),
           
           lag2Hourswind = dplyr::lag(Wind_Speed,2),
           lag3Hourswind = dplyr::lag(Wind_Speed,3),
           lag4Hourswind = dplyr::lag(Wind_Speed,4),
           lag12Hourswind = dplyr::lag(Wind_Speed,12),
           lag1daywind = dplyr::lag(Wind_Speed,24),
           
           week = week(intervalhour),
           weekday = weekdays(intervalhour)) %>% 
   ungroup()



### Making all new NAs ZERO ~~~~

train.weather.panel[c("lagHour", "lag2Hours", "lag3Hours", "lag4Hours", "lag12Hours","lag1day", "lag2Hoursrain", "lag3Hoursrain", "lag4Hoursrain", "lag12Hoursrain", "lag1dayrain", "lag2Hourstemp", "lag3Hourstemp", "lag4Hourstemp", "lag12Hourstemp", "lag1daytemp", "lag2Hourswind", "lag3Hourswind", "lag4Hourswind", "lag12Hourswind", "lag1daywind")][is.na(train.weather.panel[c("lagHour", "lag2Hours", "lag3Hours", "lag4Hours", "lag12Hours","lag1day", "lag2Hoursrain", "lag3Hoursrain", "lag4Hoursrain", "lag12Hoursrain", "lag1dayrain", "lag2Hourstemp", "lag3Hourstemp", "lag4Hourstemp", "lag12Hourstemp", "lag1daytemp", "lag2Hourswind", "lag3Hourswind", "lag4Hourswind", "lag12Hourswind", "lag1daywind")])] <- 0 



### NEW Train Weather Panel

NEW.tw.panel <- merge(x= NEWtrainpanel, y= weather.Panel, by= 'intervalhour', all.x= T)




```

```{r joineddf}

### Adding our Y variable
train.weather.panel<- train.weather.panel%>%mutate(y2_numeric = ifelse(late < minutes(2), 0, 1),
                                                   y2 = ifelse(late < minutes(2), "no", "yes"),
                                                   y5_numeric = ifelse(late < minutes(5), 0, 1),
                                                   y5 = ifelse(late < minutes(5), "no", "yes"),)
```





## OLD Regressions

```{r quickreg}

NEWweather.panel <- merge(x= NEWstudypanel, y= weather.Panel, by= 'intervalhour', all.x= T)


quickreg<-  NEWweather.panel%>%dplyr::select(late, Percipitation)
reg <- lm(late~ Percipitation, data=quickreg)

quickreg$predvals <- fitted(reg)


quick.plot<- ggplot(data=quickreg, aes(x=late, y=predvals)) +
    geom_point() 

```


OBJECTIVE: Create regression that will predict \# of minutes late a train line will be with information available 2 hours ahead of time ------ MOREOVER: creating a function that takes imputs (that would be asked for from the app, and spits out a prediction)



```{r features}
#Build features
#Parameterizing lines: i.e. what line is it on 
#Spatial fixed effect, characteristics of stations or so heavily co-linear
#How central something is 
#Particular lines have their own issues 
#Use case: how do you set up your model—a particular train, a particular time, particular place 
#Level of specificity the use case demands 
#Scheduled arrival time is a line → 



```

```{r traintest}
#first making a y-numeric for 1 late over 2 mins, and 0 for not late over 2mins

#Split data: train on 2 months, test on 2 weeks
## Partition --- changed this so that it is trainning on first 8 weeks, testing on last 2
set.seed(2121)
dataTrain <- filter(train.weather.panel, week < 9)
dataTest <- filter(train.weather.panel, week >= 9)


```

```{r model}
## First REG ## DID NOT WORK, "algorith did not converge, fitted probs numerically 0 or 1 occured"

#Model <- glm(y_numeric ~ .,
#                       data=dataTrain,     #### ALL VARS
#                       family="binomial" (link="logit"))

#It makes sense that these ones would not work since the number of seconds it is late will correspond perfectly with whether or not it is late...

Model1 <- glm(y_numeric ~ .,
                       data=dataTrain%>% 
                          dplyr::select(-late, -late_catagorical, -lagHour),     #### need to remove lagHour: otherwise we are making predictions based on information not available two hours out GETTING RID OF ONES THAT THROW ERRORS
                       family="binomial" (link="logit"))

Model2<- glm(y_numeric ~ .,
                        data=dataTrain %>% 
                          dplyr::select(y_numeric, #late,
                                        from,
                                        lagHour, lag2Hours, lag3Hours, Percipitation, line), #### SOME VARS NEED INTERVAL HOUR THOugh
                        family="binomial" (link="logit"))

Model3<- glm(y_numeric ~ .,
                        data=dataTrain %>% 
                          dplyr::select(y_numeric,
                                        from, 
                                        intervalhour,
                                        lagHour, lag2Hours, lag3Hours), 
                        family="binomial" (link="logit"))


Model4<- glm(y2_numeric ~ .,
                        data=dataTrain %>% 
                          dplyr::select(y2_numeric,
                                        from, 
                                        intervalhour,
                                        lag1day, lag2Hours, lag3Hours,
                                        lag12Hoursrain, lag12Hourswind, lag12Hourstemp,lag2Hoursrain, lag2Hourswind, lag2Hourstemp, line), 
                        family="binomial" (link="logit"))

Model5<- glm(y5_numeric ~ .,
                        data=dataTrain %>% 
                          dplyr::select(y5_numeric,
                                        from, 
                                        intervalhour,
                                        lag1day, lag2Hours, lag3Hours,
                                        lag12Hoursrain, lag12Hourswind, lag12Hourstemp,lag2Hoursrain, lag2Hourswind, lag2Hourstemp, line), 
                        family="binomial" (link="logit"))
```

```{r summarytable}
## after trying with the late param in model 2 i got the same error
#summary(Model)

summary1.table <- tbl_regression(Model1, exponentiate = TRUE)

summary2.table <- tbl_regression(Model2, exponentiate = TRUE) #do not use, need interval hour

summary3.table <- tbl_regression(Model3, exponentiate = TRUE)

summary4.table <- tbl_regression(Model4, exponentiate = TRUE)
summary5.table <- tbl_regression(Model5, exponentiate = TRUE)
#PROBS
```



```{r Testprobs}
## TEST PROBS **MODEL 3 --- 50% THRESH**
testProbs3 <- data.frame(Outcome = as.factor(dataTest$y_numeric),
                         Probs = predict(Model3, dataTest, type="response"))

testProbs3 <- 
  testProbs3 %>%
  mutate(predOutcome  = as.factor(ifelse(testProbs3$Probs > 0.50 , 1, 0)))

## 4

testProbs4 <- data.frame(
                         Outcome = as.factor(dataTest$y2_numeric),
                         Probs = predict(Model4, dataTest, type="response"))

testProbs4 <- 
  testProbs4 %>%
  mutate(predOutcome  = as.factor(ifelse(testProbs4$Probs > 0.57 , 1, 0)))

## 5 
testProbs5 <- data.frame(Outcome = as.factor(dataTest$y5_numeric),
                         Probs = predict(Model5, dataTest, type="response"))

testProbs5 <- 
  testProbs5 %>%
  mutate(predOutcome  = as.factor(ifelse(testProbs5$Probs > 0.50 , 1, 0)))



```


```{r roc}


## iterate THRESH
testProbs4.thresholds <- 
  iterateThresholds(data=testProbs4, observedClass = Outcome, 
                    predictedProbs = Probs)

testProbs4.thresholds%>%arrange(Rate_TP,Rate_TN) ## 0.57 identified

aucTable <- 
  testProbs4 %>% mutate(AUC = auc(Outcome,Probs)) %>% 
  mutate(AUC = as.character(round(AUC, 3))) 



```






```{r distribution}

## TEST PROBS PLOT **MODEL 3 --- 50% THRESH**

 three<- ggplot(testProbs3, aes(x = Probs, fill = as.factor(Outcome))) + 
  geom_density() +
  facet_grid(Outcome ~ .) +
  scale_fill_manual(values = palette2) +
  labs(x = "Late Over 2 Mins", y = "Density of probabilities",
       title = "Third Model: Distribution of Predicted Probabilities by Observed Outcome",
       caption= "Fig.6") +
  theme(strip.text.x = element_text(size = 18),
        legend.position = "none")


## TEST PROBS PLOT **MODEL 4 --- 50% THRESH**

 four<- ggplot(testProbs4, aes(x = Probs, fill = as.factor(Outcome))) + 
  geom_density() +
  facet_grid(Outcome ~ .) +
  scale_fill_manual(values = palette2) +
  labs(x = "Late Over 2 Mins", y = "Density of probabilities",
       title = "Fourth Model: Distribution of Predicted Probabilities by Observed Outcome",
       caption= "Fig.6") +
  theme(strip.text.x = element_text(size = 18),
        legend.position = "none")+plotTheme2()
 
 
## TEST PROBS PLOT **MODEL 5 --- 50% THRESH**

 five <- ggplot(testProbs5, aes(x = Probs, fill = as.factor(Outcome))) + 
  geom_density() +
  facet_grid(Outcome ~ .) +
  scale_fill_manual(values = palette2) +
  labs(x = "Late Over 5 Mins", y = "Density of probabilities",
       title = "Five Model: Distribution of Predicted Probabilities by Observed Outcome",
       caption= "Fig.6") +
  theme(strip.text.x = element_text(size = 18),
        legend.position = "none")
 
 
 plot_grid(three, four, five, ncol = 1, nrow=3)
```


```{r validation}


## Cross Validation 

ctrl <- trainControl(method = "cv", number = 100, classProbs=TRUE, summaryFunction=twoClassSummary)

#### Model 3 ----


  #define the variables we want
Model3.vars <- colnames(train.weather.panel%>%dplyr::select(
                                        from, 
                                        intervalhour,
                                        lagHour, lag2Hours, lag3Hours))


cvFit3 <- caret::train(y2 ~ .,
                       data=train.weather.panel %>%dplyr::select(all_of(Model3.vars), y2), 
                       method="glm", family="binomial",
                       metric="ROC", trControl = ctrl)

cvFit3.plot<- dplyr::select(cvFit3$resample, -Resample) %>%
  gather(metric, value) %>%
  left_join(gather(cvFit3$results[2:4], metric, mean)) %>%
  ggplot(aes(value)) + 
  geom_histogram(bins=35, fill = "#93afdc") +
  facet_wrap(~metric) +
  geom_vline(aes(xintercept = mean), colour = "#a81010", linetype = 3, size = 1.5) +
  scale_x_continuous(limits = c(0, 1)) +
  labs(x="Goodness of Fit", y="Count", title="MODEL 3 Goodness of Fit Metrics",
       subtitle = "Across-fold mean reprented as dotted lines",
       caption= "Fig.10") +
  plotTheme2()


("#a81010", "#f8cd12", "#93afdc")
#### Model 4 ----


  #define the variables we want
Model4.vars <- colnames(dataTest%>%dplyr::select(
                                        from, 
                                        intervalhour,
                                        lag1day, lag2Hours, lag3Hours,
                                        lag12Hoursrain, lag12Hourswind, lag12Hourstemp,lag2Hoursrain, lag2Hourswind, lag2Hourstemp, line))


cvFit4 <- caret::train(y2 ~ .,
                       data=dataTest %>%dplyr::select(all_of(Model4.vars), y2), 
                       method="glm", family="binomial",
                       metric="ROC", trControl = ctrl)


cvFit4.plot <-dplyr::select(cvFit4$resample, -Resample) %>%
  gather(metric, value) %>%
  left_join(gather(cvFit4$results[2:4], metric, mean)) %>%
  ggplot(aes(value)) + 
  geom_histogram(bins=35, fill = "#93afdc") +
  facet_wrap(~metric) +
  geom_vline(aes(xintercept = mean), colour = "#a81010", linetype = 3, size = 1.5) +
  scale_x_continuous(limits = c(0, 1)) +
  labs(x="Goodness of Fit", y="Count", title="MODEL 4 Goodness of Fit Metrics",
       subtitle = "Across-fold mean reprented as dotted lines",
       caption= "Fig.10") +
  plotTheme2()



#### Model 5 ----


  #define the variables we want
Model5.vars <- colnames(train.weather.panel%>%dplyr::select(
                                        from, 
                                        intervalhour,
                                        lag1day, lag2Hours, lag3Hours,
                                        lag12Hoursrain, lag12Hourswind, lag12Hourstemp,lag2Hoursrain, lag2Hourswind, lag2Hourstemp, line))


cvFit5 <- caret::train(y5 ~ .,
                       data=train.weather.panel %>%dplyr::select(all_of(Model5.vars), y5), 
                       method="glm", family="binomial",
                       metric="ROC", trControl = ctrl)

cvFit5.plot<- dplyr::select(cvFit5$resample, -Resample) %>%
  gather(metric, value) %>%
  left_join(gather(cvFit5$results[2:4], metric, mean)) %>%
  ggplot(aes(value)) + 
  geom_histogram(bins=35, fill = "#FFB000") +
  facet_wrap(~metric) +
  geom_vline(aes(xintercept = mean), colour = "#648FFF", linetype = 3, size = 1.5) +
  scale_x_continuous(limits = c(0, 1)) +
  labs(x="Goodness of Fit", y="Count", title="MODEL 5 Goodness of Fit Metrics",
       subtitle = "Across-fold mean reprented as dotted lines",
       caption= "Fig.10") +
  plotTheme2()


plot_grid(cvFit3.plot, cvFit4.plot, cvFit5.plot, nrow=3)




```



## Visuals --- SOME OLD SOME STILL USEFUL

```{r MAPs}
### MAPS ------


## prep

njGEO <- st_read("https://data.ci.newark.nj.us/dataset/db87f66a-6d79-4933-9011-f392fdce7eb8/resource/95db8cad-3a8c-41a4-b8b1-4991990f07f3/download/njcountypolygonv2.geojson")
njGEO<-njGEO%>%st_transform(crs =3424)

nyc<- st_read("https://raw.githubusercontent.com/bri-ne/MUSA508-Final/main/data/zip_code_040114.geojson?token=AVOS24OUEGLGAJL6MAR6GOLBXPUA4")

gladcounties<-c( 	
"Morris",
"Somerset",	
"Union", 	
"Bergen",
"Essex",
"Hudson")

bergcounties<-c(	
                "Morris",
                "Sussex", 	
                "Union", 	
                "Bergen",
                "Essex",
                "Hudson", 	
                "Passaic")

gladnjtrim <- njGEO%>%
  filter(county %in% gladcounties)
bergnjtrim <- njGEO%>%
  filter(county %in% bergcounties)


bergMAP8<- ggplot()+
  geom_sf(data=bergnjtrim, fill="grey80")+
  geom_sf(data=nyc, fill="grey80")+
geom_sf(data = bergGEOM%>%dplyr::filter(hour == 13 & week ==2)%>% mutate(weekday = fct_reorder(weekday, daynumeric)),
          shape=21, color= 'grey10', alpha = 0.6,
          aes(size = q5(lateM),
              fill= q5(lateM)))+
  scale_size_manual(name = "Minutes Late",
                    labels = qBr(bergGEOM, "lateM"),
                     values= c(1,2,3,4,5))+
  scale_fill_brewer(
    type = "seq",
    palette = "BuPu",
    direction = 1,
    aesthetics = "fill", 
    guide= "none"
  )+
  labs(title = "Bergen Co Line: Minutes Late By Stop 8:00 AM Hour ET")+ 
       #subtitle = "By Tract, Boston 2013-2018",
       #caption = "Figure 3.1")+
  guides(size = guide_legend(override.aes = list(fill = brewer.pal(5, name="BuPu"))
    ))+
      facet_wrap(~ weekday, ncol=7)+mapTheme()

bergMAPnoon<- ggplot()+
  geom_sf(data=bergnjtrim, fill="grey80")+
  geom_sf(data=nyc, fill="grey80")+
geom_sf(data = bergGEOM%>%dplyr::filter(hour == 5 & week ==2)%>% mutate(weekday = fct_reorder(weekday, daynumeric)),
          shape=21, color= 'grey10', alpha = 0.6,
          aes(size = q5(lateM),
              fill= q5(lateM)))+
  scale_size_manual(name = "Minutes Late",
                    labels = qBr(bergGEOM, "lateM"),
                     values= c(1,2,3,4,5))+
  scale_fill_brewer(
    type = "seq",
    palette = "BuPu",
    direction = 1,
    aesthetics = "fill", 
    guide= "none"
  )+
  labs(title = "Bergen Co Line: Minutes Late By Stop 12:00 PM Hour ET")+ 
       #subtitle = "By Tract, Boston 2013-2018",
       #caption = "Figure 3.1")+
  guides(size = guide_legend(override.aes = list(fill = brewer.pal(5, name="BuPu"))
    ))+
      facet_wrap(~ weekday, ncol=7)+mapTheme()







gladMAP8<- ggplot()+
  geom_sf(data=gladnjtrim, fill="grey80")+
geom_sf(data = gladGEOM%>%dplyr::filter(hour == 13 & week ==4)%>% mutate(weekday = fct_reorder(weekday, daynumeric)),
          shape=21, color= 'grey10', alpha = 0.6,
          aes(size = q5(lateM),
              fill= q5(lateM)))+
  scale_size_manual(name = "Minutes Late",
                    labels = qBr(bergGEOM, "lateM"),
                     values= c(1,2,3,4,5))+
  scale_fill_brewer(
    type = "seq",
    palette = "BuPu",
    direction = 1,
    aesthetics = "fill", 
    guide= "none"
  )+
  labs(title = "Gladstone Branch: Minutes Late By Stop 8:00 AM Hour ET")+
       #subtitle = "By Tract, Boston 2013-2018",
       #caption = "Figure 3.1")+
  guides(size = guide_legend(override.aes = list(fill = brewer.pal(5, name="BuPu"))
    ))+
      facet_wrap(~ weekday, ncol = 5)+mapTheme()

gladMAPnoon<- ggplot()+
  geom_sf(data=gladnjtrim, fill="grey80")+
geom_sf(data = gladGEOM%>%dplyr::filter(hour == 5 & week ==4)%>% mutate(weekday = fct_reorder(weekday, daynumeric)),
          shape=21, color= 'grey10', alpha = 0.6,
          aes(size = q5(lateM),
              fill= q5(lateM)))+
  scale_size_manual(name = "Minutes Late",
                    labels = qBr(bergGEOM, "lateM"),
                     values= c(1,2,3,4,5))+
  scale_fill_brewer(
    type = "seq",
    palette = "BuPu",
    direction = 1,
    aesthetics = "fill", 
    guide= "none"
  )+
  labs(title = "Gladstone Branch: Minutes Late By Stop 12:00 PM Hour ET")+ 
       #subtitle = "By Tract, Boston 2013-2018",
       #caption = "Figure 3.1")+
  guides(size = guide_legend(override.aes = list(fill = brewer.pal(5, name="BuPu"))
    ))+
      facet_wrap(~ weekday, ncol = 5)+mapTheme()

```


```{r LAGPLOTS}
###### LAG PLOTS -----


### looking at previous stop 
%>%group_by(stop_sequence, from)

gladIntervalstops <- gladInterval%>%st_drop_geometry()%>%filter(hour ==13 & week==2 & weekday == "Monday")%>%distinct(stop_sequence, .keep_all=TRUE)%>%arrange(stop_sequence)#%>%
                                                                                mutate(lagstop = dplyr::lag(late,1)) ## This is a Study Panel


plotData.lag <-train.weather.panel%>%
  filter(week == 2) %>%
  dplyr::select(contains("rain"), late) %>%
  gather(Variable, Value, -late) %>%
  mutate(Variable = fct_relevel(Variable, "lag2Hoursrain","lag3Hoursrain",
                                          "lag4Hoursrain","lag12Hoursrain","lag1dayrain"))
correlation.lag <-
  group_by(plotData.lag, Variable) %>%
    summarize(correlation = round(cor(Value, late, use = "complete.obs"), 2)) 





LAGplot <-ggplot(plotData.lag, aes(Value,late)) +
  geom_point(size = 0.1) +
  geom_text(data = correlation.lag, aes(label = paste("r =", round(correlation, 2))),
            x=-Inf, y=Inf, vjust = 1.5, hjust = -.1) +
  geom_smooth(method = "lm", se = FALSE, colour = "#a81010") +
  facet_wrap(~Variable, ncol = 2, scales = "free") +
  labs(title = "Train Delays as a Function of RainLag Delays",
       subtitle = "One Week in 2019") +
  plotTheme2()

```


```{r explorelag, fig.width=12, fig.height=5}

library(cowplot)
two <- train.weather.panel %>%
  group_by(y2_numeric) %>% 
  summarize(Percipitation = mean(lag4Hourswind)) %>%
    ggplot(aes(y2_numeric, Percipitation)) + geom_bar(stat = "identity", color = palette2, fill= palette2) +
      labs(title="Does lateness vary with temperature two hours ahead?",
           x="y2_numeric", y="Mean Temp 2 Hours Before Scheduled Departure") +
      plotTheme() 


five <- train.weather.panel %>%
  group_by(y5_numeric) %>% 
  summarize(Percipitation = mean(lag4Hourswind)) %>%
    ggplot(aes(y5_numeric, Percipitation)) + geom_bar(stat = "identity", color = palette2, fill= palette2) +
      labs(title="Does lateness vary with temperature two hours ahead?",
           x="y5_numeric", y="Mean Temp 2 Hours Before Scheduled Departure") +
      plotTheme() 

plot_grid(two, five)


```


```{r bar}
train.weather.panel %>%
  group_by(line) %>% 
  summarize(lateness = mean(late)) %>%
    ggplot(aes(line, lateness)) + geom_bar(stat = "identity", color = palette2, fill= palette2) +
      labs(title="Does Lateness Vary Depending on the Line?",
           x="Line", y="Mean Seconds Late", color = "#0C0E1D") +
      plotTheme2() 
```

```{r line, fig.width=10, fig.height=12} 


 #f2fdff
origin <- train.weather.panel %>%
  group_by(from) %>% 
  summarize(lateness = mean(late)) %>% mutate(from = fct_reorder(from, lateness)) %>%
    ggplot(aes(lateness, from)) + geom_bar(stat = "identity",  color = NA, fill= "#0c0e1d") +
      labs(title="Does Lateness Vary by Stop Origin",
           x="Mean seconds late", y="Origin Stop") +
  scale_y_discrete(expand = expansion(mult = c(.02, .02)))+
  scale_x_continuous(expand = expansion(mult = c(0, 0.02)))+
     plotTheme2()
```


```{r explorelag}
train.weather.panel %>%mutate(weekday = fct_reorder(weekday, day))%>%
  group_by(weekday) %>% 
  summarize(lateness = mean(late)) %>%
    ggplot(aes(weekday, lateness)) + geom_bar(stat = "identity", color = "#0c0e1d", fill= "#0c0e1d") + 
      labs(title="Does Lateness Vary With the Day of the Week?",
           x="day of the week", y="Mean seconds late") +
      plotTheme2() 
```





