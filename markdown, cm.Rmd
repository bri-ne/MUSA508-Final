---
title: "Final Project"
author: "Cypress Marrs, Briana Cervantes"
date: "12/3/2021"
output: html_document
---

# GOALS

-   is it late over 2 mins y/n LOGISTiC

## model put ins

-   lag time

-   time of day (at least two hours out)

-   line

-   station pickup (diff stations will be treated as a cat variable)

-   weather data

## model outputs 

-   is the train going to be late over 2 mins. at pickup station? Y/N

## lines we'll be working with

## Graphics - deliverable

-   Y/N outcomes for any variables

## Codewise to do, next steps: 

-   ~~choose two lines~~

-   merge the weather

    -   use this as a numeric variable at first

-   ~~merge stop location~~

    -   each stop as cat variable

-   at least get the code logistic regression

-   last step visuals

-   last last step revise, feat engineer

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r initial, include=FALSE, warning=FALSE, message=FALSE}
# Libraries -----------------
library(tidyr)
library(dplyr)
library(lubridate)
library(sf)
library(tidycensus)
library(tidyverse)
library(tigris)
library(riem)
library(gridExtra)
library(knitr)
library(kableExtra)
library(caret)
library(knitr) 
library(pscl)
library(plotROC)
library(gtsummary) #for table cause broom always f's everything up


options(tigris_class = "sf")
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")


palette4 <- c("#260a03", "#f8cd12", "#a81010", "#f2fdff", "#93afdc", "#0c0e1d")
palette3 <- c("#0C0E1D", "#7396D3", "#260A03")
palette2 <- c("#260a03", "#a81010")

```

```{r datatrains}
# Data -----------
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
jan2019 <- read.csv("https://raw.githubusercontent.com/bri-ne/MUSA508-Final/faf21b758b644d975bb7aa67c5687a38374c05b7/data/2019_01.csv?token=AVSVPET277ZFADOVJ6VXJ2TBWPIGW")
feb2019 <- read.csv("https://raw.githubusercontent.com/bri-ne/MUSA508-Final/faf21b758b644d975bb7aa67c5687a38374c05b7/data/2019_02.csv?token=AVSVPEW4NWROQR43GFRYKJTBWPIL4")
mar2019 <- read.csv("https://raw.githubusercontent.com/bri-ne/MUSA508-Final/faf21b758b644d975bb7aa67c5687a38374c05b7/data/2019_03.csv?token=AVSVPERDSFIVXOGEUPPJRPTBWPIOI")
weather.Data <- 
  riem_measures(station = "EWR", date_start = "2019-01-01", date_end = "2019-05-01")
```

```{r wrangledate}
njtransitdf <- rbind(jan2019, feb2019, mar2019)


njtransitdf <- njtransitdf %>% 
  mutate(scheduled_time_dt = as_datetime(scheduled_time),
         actual_time_dt = as_datetime(actual_time),
         delay_dt = seconds(as.integer(delay_minutes*60)), 
         intervalhour = floor_date(scheduled_time_dt, unit= "hour"),
         week = week(intervalhour)) %>%
  na.omit(delay_dt)

```

```{r stations}
stoplocations <- read.csv("https://raw.githubusercontent.com/bri-ne/MUSA508-Final/main/Rail_Stations_of_NJ_Transit.csv?token=AVSVPEVU7X6RXZP3RNOK2CLBW7VZO")

stoplocations <- stoplocations %>%rename(X = "ï..X")%>%st_as_sf(coords = c("X", "Y"), crs =3424, agr = "constant") 

#stoplocations <- stoplocations %>%st_as_sf(coords = c("ï..X", "Y"), crs =3424, agr = "constant") 
```

```{r template}

## Filters down to Week 1- 10
## Train on 8 test on 2 weeks 
train.template <- 
  filter(njtransitdf, week %in% c(1: 10))%>%filter(line == "Bergen Co. Line " | line == "Gladstone Branch")

length(unique(train.template$intervalhour)) * length(unique(train.template$line)) * length(unique(train.template$from))
```

```{r studypanel}

## 
study.panel <- 
  expand.grid(intervalhour = unique(train.template$intervalhour), 
              from = unique(train.template$from),
              line= unique(train.template$line))
              
nrow(study.panel)    

```

```{r trainpanel}
train.panel <- 
  train.template %>%
    right_join(study.panel, on=intervalhour) %>% 
      group_by(intervalhour, from, line)

### Breaking this up to curb unecessary processing on a bunch of NAS

train.panel <- train.panel%>%drop_na()

train.panel <- train.panel%>%summarize(late = mean(delay_dt, na.rm=T)) %>%
  mutate(day= wday(intervalhour),
        late_catagorical = ifelse(late < minutes(1), "ontime", ifelse(late < minutes(4), "few_minutes", "late")))

#leave this for potential use as a cat. 


```

```{r dataweather}
# Data -----------
weather.Panel <-  
  weather.Data %>%
    mutate_if(is.character, list(~replace(as.character(.), is.na(.), "0"))) %>% 
    replace(is.na(.), 0) %>%
    mutate(intervalhour = ymd_h(substr(valid, 1, 13))) %>%
    mutate(dotw = wday(intervalhour, label=TRUE)) %>%
    group_by(intervalhour) %>%
    summarize(Temperature = max(tmpf),
              Percipitation = sum(p01i),
              Wind_Speed = max(sknt)) %>%
    mutate(Temperature = ifelse(Temperature == 0, 42, Temperature)) 

#Bring in other data sources and join in legible ways that will make data useable 


```

```{r lags}
train.weather.panel <- merge(x= train.panel, y= weather.Panel, by= 'intervalhour', all.x= T)

train.weather.panel <- 
  train.weather.panel %>% 
    arrange(line, intervalhour) %>% 
    group_by(line) %>% 
    mutate(lagHour = dplyr::lag(late,1),
           lag2Hours = dplyr::lag(late,2),
           lag3Hours = dplyr::lag(late,3),
           lag4Hours = dplyr::lag(late,4),
           lag12Hours = dplyr::lag(late,12),
           lag1day = dplyr::lag(late,24),
           lag2Hoursrain = dplyr::lag(Percipitation,2),
           lag3Hoursrain = dplyr::lag(Percipitation,3),
           lag4Hoursrain = dplyr::lag(Percipitation,4),
           lag12Hoursrain = dplyr::lag(Percipitation,12),
           lag1dayrain = dplyr::lag(Percipitation,24),
           
           lag2Hourstemp = dplyr::lag(Temperature,2),
           lag3Hourstemp = dplyr::lag(Temperature,3),
           lag4Hourstemp = dplyr::lag(Temperature,4),
           lag12Hourstemp = dplyr::lag(Temperature,12),
           lag1daytemp = dplyr::lag(Temperature,24),
           
           lag2Hourswind = dplyr::lag(Wind_Speed,2),
           lag3Hourswind = dplyr::lag(Wind_Speed,3),
           lag4Hourswind = dplyr::lag(Wind_Speed,4),
           lag12Hourswind = dplyr::lag(Wind_Speed,12),
           lag1daywind = dplyr::lag(Wind_Speed,24),
           
           week = week(intervalhour)) %>% 
   ungroup()



### Making all new NAs ZERO ~~~~

train.weather.panel[c("lagHour", "lag2Hours", "lag3Hours", "lag4Hours", "lag12Hours","lag1day", "lag2Hoursrain", "lag3Hoursrain", "lag4Hoursrain", "lag12Hoursrain", "lag1dayrain", "lag2Hourstemp", "lag3Hourstemp", "lag4Hourstemp", "lag12Hourstemp", "lag1daytemp", "lag2Hourswind", "lag3Hourswind", "lag4Hourswind", "lag12Hourswind", "lag1daywind")][is.na(train.weather.panel[c("lagHour", "lag2Hours", "lag3Hours", "lag4Hours", "lag12Hours","lag1day", "lag2Hoursrain", "lag3Hoursrain", "lag4Hoursrain", "lag12Hoursrain", "lag1dayrain", "lag2Hourstemp", "lag3Hourstemp", "lag4Hourstemp", "lag12Hourstemp", "lag1daytemp", "lag2Hourswind", "lag3Hourswind", "lag4Hourswind", "lag12Hourswind", "lag1daywind")])] <- 0 

```

```{r joineddf}
train.weather.panel<- train.weather.panel%>%mutate(y_numeric = ifelse(late < minutes(2), 0, 1))
```

OBJECTIVE: Create regression that will predict \# of minutes late a train line will be with information available 2 hours ahead of time ------ MOREOVER: creating a function that takes imputs (that would be asked for from the app, and spits out a prediction)

```{r explorelag}
train.weather.panel %>%
  group_by(y_numeric) %>% 
  summarize(Percipitation = mean(lag4Hourswind)) %>%
    ggplot(aes(y_numeric, Percipitation)) + geom_bar(stat = "identity", color = palette2, fill= palette2) +
      labs(title="Does lateness vary with temperature two hours ahead?",
           x="y_numeric", y="Mean Temp 2 Hours Before Scheduled Departure") +
      plotTheme() 
```




```{r line}
train.weather.panel %>%
  group_by(line) %>% 
  summarize(lateness = mean(late)) %>%
    ggplot(aes(line, lateness)) + geom_bar(stat = "identity", color = palette2, fill= palette2) +
      labs(title="Does lateness vary depending on the line?",
           x="Line", y="Mean Seconds Late", color = "#0C0E1D") +
      plotTheme() 
```


```{r explorelag}
train.weather.panel %>%
  group_by(day) %>% 
  summarize(lateness = mean(late)) %>%
    ggplot(aes(day, lateness)) + geom_bar(stat = "identity", color = "#a81010", fill= "#a81010") +
      labs(title="Does lateness vary with the day of the week?",
           x="day of the week", y="Mean seconds late") +
      plotTheme() 
```


```{r features}
#Build features
#Parameterizing lines: i.e. what line is it on 
#Spatial fixed effect, characteristics of stations or so heavily co-linear
#How central something is 
#Particular lines have their own issues 
#Use case: how do you set up your model—a particular train, a particular time, particular place 
#Level of specificity the use case demands 
#Scheduled arrival time is a line → 

```

```{r traintest}
#first making a y-numeric for 1 late over 2 mins, and 0 for not late over 2mins

#Split data: train on 2 months, test on 2 weeks
## Partition --- changed this so that it is trainning on first 8 weeks, testing on last 2
set.seed(2121)
dataTrain <- filter(train.weather.panel, week < 9)
dataTest <- filter(train.weather.panel, week >= 9)


```

```{r model}
## First REG ## DID NOT WORK, "algorith did not converge, fitted probs numerically 0 or 1 occured"

#Model <- glm(y_numeric ~ .,
#                       data=dataTrain,     #### ALL VARS
#                       family="binomial" (link="logit"))

#It makes sense that these ones would not work since the number of seconds it is late will correspond perfectly with whether or not it is late...

Model1 <- glm(y_numeric ~ .,
                       data=dataTrain%>% 
                          dplyr::select(-late, -late_catagorical, -lagHour),     #### need to remove lagHour: otherwise we are making predictions based on information not available two hours out GETTING RID OF ONES THAT THROW ERRORS
                       family="binomial" (link="logit"))

Model2<- glm(y_numeric ~ .,
                        data=dataTrain %>% 
                          dplyr::select(y_numeric, #late,
                                        from,
                                        lagHour, lag2Hours, lag3Hours, Percipitation, line), #### SOME VARS NEED INTERVAL HOUR THOugh
                        family="binomial" (link="logit"))

Model3<- glm(y_numeric ~ .,
                        data=dataTrain %>% 
                          dplyr::select(y_numeric,
                                        from, 
                                        intervalhour,
                                        lagHour, lag2Hours, lag3Hours), 
                        family="binomial" (link="logit"))


Model4<- glm(y_numeric ~ .,
                        data=dataTrain %>% 
                          dplyr::select(y_numeric,
                                        from, 
                                        intervalhour,
                                        lag1day, lag2Hours, lag3Hours,
                                        lag12Hoursrain, lag12Hourswind, lag12Hourstemp,lag2Hoursrain, lag2Hourswind, lag2Hourstemp, line), 
                        family="binomial" (link="logit"))
```

```{r summarytable}
## after trying with the late param in model 2 i got the same error
#summary(Model)

summary1.table <- tbl_regression(Model1, exponentiate = TRUE)

summary2.table <- tbl_regression(Model2, exponentiate = TRUE) #do not use, need interval hour

summary3.table <- tbl_regression(Model3, exponentiate = TRUE)

summary4.table <- tbl_regression(Model4, exponentiate = TRUE)
#PROBS
```


```{r model3}
## TEST PROBS **MODEL 3 --- 50% THRESH**

testProbs3 <- data.frame(Outcome = as.factor(dataTest$y_numeric),
                         Probs = predict(Model3, dataTest, type="response"))

testProbs3 <- 
  testProbs3 %>%
  mutate(predOutcome  = as.factor(ifelse(testProbs3$Probs > 0.50 , 1, 0)))



## TEST PROBS PLOT **MODEL 3 --- 50% THRESH**

 ggplot(testProbs3, aes(x = Probs, fill = as.factor(Outcome))) + 
  geom_density() +
  facet_grid(Outcome ~ .) +
  scale_fill_manual(values = palette2) +
  labs(x = "Late Over 2 Mins", y = "Density of probabilities",
       title = "Third Model: Distribution of Predicted Probabilities by Observed Outcome",
       caption= "Fig.6") +
  theme(strip.text.x = element_text(size = 18),
        legend.position = "none")


```
```{r distribution}
testProbs4 <- data.frame(Outcome = as.factor(dataTest$y_numeric),
                         Probs = predict(Model4, dataTest, type="response"))

testProbs4 <- 
  testProbs4 %>%
  mutate(predOutcome  = as.factor(ifelse(testProbs4$Probs > 0.50 , 1, 0))) 

ggplot(testProbs4, aes(x = Probs, fill = as.factor(Outcome))) + 
  geom_density() +
  facet_grid(Outcome ~ .) +
  scale_fill_manual(values = palette2) +
  labs(x = "Late Over 2 Mins", y = "Density of probabilities",
       title = "Fourth Model: Distribution of Predicted Probabilities by Observed Outcome",
       caption= "Fig.6") +
  theme(strip.text.x = element_text(size = 18, color = ""),
        legend.position = "none")
```
```{r validation}
```
