---
title: "Final Project"
author: "Cypress Marrs, Briana Cervantes"
date: "12/3/2021"
output: html_document
---

# GOALS

-   is it late over 2 mins y/n LOGISTiC

## model put ins

-   lag time

-   time of day (at least two hours out)

-   line

-   station pickup (diff stations will be treated as a cat variable)

-   weather data

## model outputs 

-   is the train going to be late over 2 mins. at pickup station? Y/N

## lines we'll be working with

## Graphics - deliverable

-   Y/N outcomes for any variables

## Codewise to do, next steps: 

-   ~~choose two lines~~

-   merge the weather

    -   use this as a numeric variable at first

-   ~~merge stop location~~

    -   each stop as cat variable

-   at least get the code logistic regression

-   last step visuals

-   last last step revise, feat engineer

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r initial}
# Libraries -----------------
library(tidyr)
library(dplyr)
library(lubridate)
library(sf)
library(tidycensus)
library(tidyverse)
library(tigris)
library(riem)
library(gridExtra)
library(knitr)
library(kableExtra)
library(caret)

library(knitr) 
library(pscl)
library(plotROC)
library(gtsummary) #for table cause broom always f's everything up


options(tigris_class = "sf")
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

palette5 <- c("#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c")
palette4 <- c("#D2FBD4","#92BCAB","#527D82","#123F5A")
palette2 <- c("#6baed6","#08519c")
```

```{r datatrains}
# Data -----------
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
jan2019 <- read.csv("https://raw.githubusercontent.com/bri-ne/MUSA508-Final/faf21b758b644d975bb7aa67c5687a38374c05b7/data/2019_01.csv?token=AVSVPET277ZFADOVJ6VXJ2TBWPIGW")
feb2019 <- read.csv("https://raw.githubusercontent.com/bri-ne/MUSA508-Final/faf21b758b644d975bb7aa67c5687a38374c05b7/data/2019_02.csv?token=AVSVPEW4NWROQR43GFRYKJTBWPIL4")
mar2019 <- read.csv("https://raw.githubusercontent.com/bri-ne/MUSA508-Final/faf21b758b644d975bb7aa67c5687a38374c05b7/data/2019_03.csv?token=AVSVPERDSFIVXOGEUPPJRPTBWPIOI")
weather.Data <- 
  riem_measures(station = "EWR", date_start = "2019-01-01", date_end = "2019-05-01")
```

```{r wrangledate}
njtransitdf <- rbind(jan2019, feb2019, mar2019)


njtransitdf <- njtransitdf %>% 
  mutate(scheduled_time_dt = as_datetime(scheduled_time),
         actual_time_dt = as_datetime(actual_time),
         delay_dt = seconds(as.integer(delay_minutes*60)), 
         intervalhour = floor_date(scheduled_time_dt, unit= "hour"),
         week = week(intervalhour)) %>%
  na.omit(delay_dt)

```

```{r stations}
stoplocations <- read.csv("https://raw.githubusercontent.com/bri-ne/MUSA508-Final/main/Rail_Stations_of_NJ_Transit.csv?token=AVSVPEVU7X6RXZP3RNOK2CLBW7VZO")

stoplocations <- stoplocations %>%
  st_as_sf(coords = c("ï..X", "Y"), crs =3424, agr = "constant") 
```

```{r template}

## Filters down to Week 1- 10
## Train on 8 test on 2 weeks 
train.template <- 
  filter(njtransitdf, week %in% c(1: 10))%>%filter(line == "Bergen Co. Line " | line == "Gladstone Branch")

length(unique(train.template$intervalhour)) * length(unique(train.template$line)) * length(unique(train.template$from))
```

```{r studypanel}

## 
study.panel <- 
  expand.grid(intervalhour = unique(train.template$intervalhour), 
              from = unique(train.template$from),
              line= unique(train.template$line))
              
nrow(study.panel)    

```

```{r trainpanel}
train.panel <- 
  train.template %>%
    right_join(study.panel, on=intervalhour) %>% 
      group_by(intervalhour, from, line)

### Breaking this up to curb unecessary processing on a bunch of NAS

train.panel <- train.panel%>%drop_na()

train.panel <- train.panel%>%summarize(late = mean(delay_dt, na.rm=T)) %>%
  mutate(day= wday(intervalhour),
        late_catagorical = ifelse(late < minutes(1), "ontime", ifelse(late < minutes(4), "few_minutes", "late")))

#leave this for potential use as a cat. 


```

```{r dataweather}
# Data -----------
weather.Data <- 
  riem_measures(station = "EWR", date_start = "2019-01-01", date_end = "2019-05-01")

weather.Panel <-  
  weather.Data %>%
    mutate_if(is.character, list(~replace(as.character(.), is.na(.), "0"))) %>% 
    replace(is.na(.), 0) %>%
    mutate(intervalhour = ymd_h(substr(valid, 1, 13))) %>%
    mutate(week = week(intervalhour),
           dotw = wday(intervalhour, label=TRUE)) %>%
    group_by(intervalhour) %>%
    summarize(Temperature = max(tmpf),
              Percipitation = sum(p01i),
              Wind_Speed = max(sknt)) %>%
    mutate(Temperature = ifelse(Temperature == 0, 42, Temperature)) 

#Bring in other data sources and join in legible ways that will make data useable 


```

```{r lags}
train.panel <- 
  train.panel %>% 
    arrange(line, intervalhour) %>% 
    group_by(line) %>% 
    mutate(lagHour = dplyr::lag(late,1),
           lag2Hours = dplyr::lag(late,2),
           lag3Hours = dplyr::lag(late,3),
           lag4Hours = dplyr::lag(late,4),
           lag12Hours = dplyr::lag(late,12),
           lag1day = dplyr::lag(late,24)) %>% 
   ungroup()



### Making all new NAs ZERO ~~~~

train.panel[c("lagHour", "lag2Hours", "lag3Hours", "lag4Hours", "lag12Hours","lag1day")][is.na(train.panel[c("lagHour", "lag2Hours", "lag3Hours", "lag4Hours", "lag12Hours","lag1day")])] <- 0 

```

```{r joineddf}
train.weather.panel <- merge(x= train.panel, y= weather.Panel, by= 'intervalhour', all.x= T)


```

OBJECTIVE: Create regression that will predict \# of minutes late a train line will be with information available 2 hours ahead of time ------ MOREOVER: creating a function that takes imputs (that would be asked for from the app, and spits out a prediction)

```{r explore}
#Do exploratory analysis to understand which variables will be useful features
#inculde some number of these in our presentation and write up 
```

```{r features}
#Build features
#Parameterizing lines: i.e. what line is it on 
#Spatial fixed effect, characteristics of stations or so heavily co-linear
#How central something is 
#Particular lines have their own issues 
#Use case: how do you set up your model—a particular train, a particular time, particular place 
#Level of specificity the use case demands 
#Scheduled arrival time is a line → 

```

```{r model}
#first making a y-numeric for 1 late over 2 mins, and 0 for not late over 2mins

train.weather.panel<- train.weather.panel%>%mutate(y_numeric = ifelse(late < minutes(2), 0, 1))


#Split data: train on 2 months, test on 2 weeks

## Partition
set.seed(2121)
trainIndex <- createDataPartition(train.weather.panel$y_numeric, p = .65,
                                  list = FALSE,
                                  times = 1)
dataTrain <- train.weather.panel[ trainIndex,]
dataTest  <- train.weather.panel[-trainIndex,]

## First REG

Model1 <- glm(y_numeric ~ .,
                        data=dataTrain,     #### Just getting rid of index
                        family="binomial" (link="logit"))

#summary(Model)

summary1.table <- tbl_regression(Model1, exponentiate = TRUE)






Process modeling 
```

```{r validation}
```
